An aerosol representation acts as an interface between an aerosol micro-\/physics model and the \mbox{\hyperlink{phlex_chem}{phlex-\/chem}} chemistry module. Types that extend the abstract {\ttfamily aero\+\_\+rep\+\_\+data\+\_\+t} type should be developed for each type of aerosol representation used by an external model (e.\+g., binned, modal, single particle).

The available aerosol representations are\+:
\begin{DoxyItemize}
\item \mbox{\hyperlink{phlex_aero_rep_single_particle}{Single Particle}}
\item \mbox{\hyperlink{phlex_aero_rep_modal_binned_mass}{Mass-\/only Binned/\+Modal}}
\end{DoxyItemize}

The general input format for an aerosol representation can be found \mbox{\hyperlink{input_format_aero_rep}{here}}.

General instructions for adding a new aerosol representation can be found \mbox{\hyperlink{phlex_aero_rep_add}{here}}. \hypertarget{phlex_aero_rep_single_particle}{}\section{Phlexible Module for Chemistry\+: Single Particle Aerosol Representation}\label{phlex_aero_rep_single_particle}
The single particle aerosol representation is for use with a Part\+MC particle-\/resolved run. The {\ttfamily json} object for this \mbox{\hyperlink{phlex_aero_rep}{aerosol representation}} has the following format\+:


\begin{DoxyCode}
\{ "pmc-data" : [
  \{
    "name" : "my single particle aero rep",
    "type" : "AERO\_REP\_SINGLE\_PARTICLE"
  \},
  ...
]\}
\end{DoxyCode}
 The key-\/value pair {\bfseries type} is required and must be {\bfseries A\+E\+R\+O\+\_\+\+R\+E\+P\+\_\+\+S\+I\+N\+G\+L\+E\+\_\+\+P\+A\+R\+T\+I\+C\+LE}. This representation assumes that every \mbox{\hyperlink{input_format_aero_phase}{aerosol phase}} available will be present once in each particle, and that the \mbox{\hyperlink{input_format_mechanism}{chemical mechanisms}} will be solved at each time step first for the gas-\/phase then for phase-\/transfer and aerosol-\/phase chemistry for each single particle in the {\ttfamily \mbox{\hyperlink{structpmc__aero__particle__array_1_1aero__particle__array__t}{pmc\+\_\+aero\+\_\+particle\+\_\+array\+::aero\+\_\+particle\+\_\+array\+\_\+t}}} variable sequentially. This may be changed in the future to solve for all particles simultaneously. \hypertarget{phlex_aero_rep_modal_binned_mass}{}\section{Phlexible Module for Chemistry\+: Modal/\+Binned Mass Aerosol Representation}\label{phlex_aero_rep_modal_binned_mass}
The modal/binned mass aerosol representation includes a set of sections/bins that are made up of one or more \mbox{\hyperlink{phlex_aero_phase}{aerosol phases.}} The {\ttfamily json} object for this \mbox{\hyperlink{phlex_aero_rep}{aerosol representation}} has the following format\+:


\begin{DoxyCode}
\{ "pmc-data" : [
  \{
    "name" : "my modal/binned aero rep",
    "type" : "AERO\_REP\_MODAL\_BINNED\_MASS",
    "modes/bins" : 
    \{
      "dust" : 
      \{
        "type" : "BINNED",
        "phases" : [ "insoluble", "organic", "aqueous" ],
        "bins" : 8,
        "minimum diameter" : 0.8e-9,
        "maximum deviation" : 1.0e-6,
        "scale" : "LOG"
      \},
      "depeche" :
      \{
        "type" : "MODAL",
        "phases" : [ "moody", "listless" ],
        "shape" : "LOG\_NORMAL",
        "geometric mean diameter" : 1.2e-6,
        "geometric standard deviation" : 1.2
      \}
    \}
  \},
  ...
]\}
\end{DoxyCode}
 The key-\/value pair {\bfseries type} is required and must be {\bfseries A\+E\+R\+O\+\_\+\+R\+E\+P\+\_\+\+M\+O\+D\+A\+L\+\_\+\+B\+I\+N\+N\+E\+D\+\_\+\+M\+A\+SS}. The key-\/value pair {\bfseries modes/bins} is also required and must contain a set of at least one uniquely named mode or bin-\/set key-\/value pair whose value(s) specify a {\bfseries type} that must be either {\bfseries M\+O\+D\+AL} or {\bfseries B\+I\+N\+N\+ED} and an array of {\bfseries phases} that correspond to existing \mbox{\hyperlink{phlex_aero_phase}{aerosol phase}} objects. Each phase will be present once within a mode or once within each bin in a bin-\/set.

Modes must also specify a distribution {\bfseries shape} which must be {\bfseries L\+O\+G\+\_\+\+N\+O\+R\+M\+AL} (the available shapes may be expanded in the future). Log-\/normal sections must include a {\bfseries geometric} {\bfseries mean} {\bfseries diameter} (m) and a {\bfseries geometric} {\bfseries standard} {\bfseries deviation} (unitless) that will be used along with the mass concentration of species in each phase and their densities to calculate a lognormal distribution for each mode at runtime.

Bin sets must specify the number of {\bfseries bins}, a {\bfseries minimum} {\bfseries diameter} (m), a {\bfseries maximum} {\bfseries diameter} (m) and a {\bfseries scale}, which must be {\bfseries L\+OG} or {\bfseries L\+I\+N\+E\+AR}. The number concentration will be calculated at run-\/time based on the total mass of each bin, the species densities and the diameter of particles in that bin. \hypertarget{input_format_aero_rep}{}\section{Input J\+S\+ON Object Format\+: Aerosol Representation (general)}\label{input_format_aero_rep}
A {\ttfamily json} object containing information about an \mbox{\hyperlink{phlex_aero_rep}{aerosol representation}} has the following format\+:


\begin{DoxyCode}
\{ "pmc-data" : [
  \{
    "name" : "my aero rep",
    "type" : "AERO\_REP\_TYPE",
    "some parameter" : 123.34,
    "some other parameter" : true,
    "nested parameters" : \{
      "sub param 1" : 12.43,
      "sub param other" : "some text",
      ...
    \},
    ...
  \},
  ...
]\}
\end{DoxyCode}
 Aerosol representations must have a unique {\bfseries name} that will be used to identify the aerosol representation during initialization. The key-\/value pair {\bfseries type} is also required and must correspond to a valid aerosol representation type. These include\+:


\begin{DoxyItemize}
\item \mbox{\hyperlink{phlex_aero_rep_single_particle}{A\+E\+R\+O\+\_\+\+R\+E\+P\+\_\+\+S\+I\+N\+G\+L\+E\+\_\+\+P\+A\+R\+T\+I\+C\+LE}}
\item \mbox{\hyperlink{phlex_aero_rep_modal_binned_mass}{A\+E\+R\+O\+\_\+\+R\+E\+P\+\_\+\+M\+O\+D\+A\+L\+\_\+\+B\+I\+N\+N\+E\+D\+\_\+\+M\+A\+SS}}
\end{DoxyItemize}

All remaining data are optional and may include any valid {\ttfamily json} value. However, extending types will have specific requirements for the remaining data. \hypertarget{phlex_aero_rep_single_particle}{}\subsubsection{Phlexible Module for Chemistry\+: Single Particle Aerosol Representation}\label{phlex_aero_rep_single_particle}
The single particle aerosol representation is for use with a Part\+MC particle-\/resolved run. The {\ttfamily json} object for this \mbox{\hyperlink{phlex_aero_rep}{aerosol representation}} has the following format\+:


\begin{DoxyCode}
\{ "pmc-data" : [
  \{
    "name" : "my single particle aero rep",
    "type" : "AERO\_REP\_SINGLE\_PARTICLE"
  \},
  ...
]\}
\end{DoxyCode}
 The key-\/value pair {\bfseries type} is required and must be {\bfseries A\+E\+R\+O\+\_\+\+R\+E\+P\+\_\+\+S\+I\+N\+G\+L\+E\+\_\+\+P\+A\+R\+T\+I\+C\+LE}. This representation assumes that every \mbox{\hyperlink{input_format_aero_phase}{aerosol phase}} available will be present once in each particle, and that the \mbox{\hyperlink{input_format_mechanism}{chemical mechanisms}} will be solved at each time step first for the gas-\/phase then for phase-\/transfer and aerosol-\/phase chemistry for each single particle in the {\ttfamily \mbox{\hyperlink{structpmc__aero__particle__array_1_1aero__particle__array__t}{pmc\+\_\+aero\+\_\+particle\+\_\+array\+::aero\+\_\+particle\+\_\+array\+\_\+t}}} variable sequentially. This may be changed in the future to solve for all particles simultaneously. \hypertarget{phlex_aero_rep_modal_binned_mass}{}\subsubsection{Phlexible Module for Chemistry\+: Modal/\+Binned Mass Aerosol Representation}\label{phlex_aero_rep_modal_binned_mass}
The modal/binned mass aerosol representation includes a set of sections/bins that are made up of one or more \mbox{\hyperlink{phlex_aero_phase}{aerosol phases.}} The {\ttfamily json} object for this \mbox{\hyperlink{phlex_aero_rep}{aerosol representation}} has the following format\+:


\begin{DoxyCode}
\{ "pmc-data" : [
  \{
    "name" : "my modal/binned aero rep",
    "type" : "AERO\_REP\_MODAL\_BINNED\_MASS",
    "modes/bins" : 
    \{
      "dust" : 
      \{
        "type" : "BINNED",
        "phases" : [ "insoluble", "organic", "aqueous" ],
        "bins" : 8,
        "minimum diameter" : 0.8e-9,
        "maximum deviation" : 1.0e-6,
        "scale" : "LOG"
      \},
      "depeche" :
      \{
        "type" : "MODAL",
        "phases" : [ "moody", "listless" ],
        "shape" : "LOG\_NORMAL",
        "geometric mean diameter" : 1.2e-6,
        "geometric standard deviation" : 1.2
      \}
    \}
  \},
  ...
]\}
\end{DoxyCode}
 The key-\/value pair {\bfseries type} is required and must be {\bfseries A\+E\+R\+O\+\_\+\+R\+E\+P\+\_\+\+M\+O\+D\+A\+L\+\_\+\+B\+I\+N\+N\+E\+D\+\_\+\+M\+A\+SS}. The key-\/value pair {\bfseries modes/bins} is also required and must contain a set of at least one uniquely named mode or bin-\/set key-\/value pair whose value(s) specify a {\bfseries type} that must be either {\bfseries M\+O\+D\+AL} or {\bfseries B\+I\+N\+N\+ED} and an array of {\bfseries phases} that correspond to existing \mbox{\hyperlink{phlex_aero_phase}{aerosol phase}} objects. Each phase will be present once within a mode or once within each bin in a bin-\/set.

Modes must also specify a distribution {\bfseries shape} which must be {\bfseries L\+O\+G\+\_\+\+N\+O\+R\+M\+AL} (the available shapes may be expanded in the future). Log-\/normal sections must include a {\bfseries geometric} {\bfseries mean} {\bfseries diameter} (m) and a {\bfseries geometric} {\bfseries standard} {\bfseries deviation} (unitless) that will be used along with the mass concentration of species in each phase and their densities to calculate a lognormal distribution for each mode at runtime.

Bin sets must specify the number of {\bfseries bins}, a {\bfseries minimum} {\bfseries diameter} (m), a {\bfseries maximum} {\bfseries diameter} (m) and a {\bfseries scale}, which must be {\bfseries L\+OG} or {\bfseries L\+I\+N\+E\+AR}. The number concentration will be calculated at run-\/time based on the total mass of each bin, the species densities and the diameter of particles in that bin. \hypertarget{phlex_aero_rep_add}{}\section{Phlexible Module for Chemistry\+: Adding an Aerosol Representation}\label{phlex_aero_rep_add}
N\+O\+TE\+: These instructions are out-\/of-\/date. T\+O\+DO update

Adding an \mbox{\hyperlink{phlex_aero_rep}{aerosol representation}} to the \mbox{\hyperlink{phlex_chem}{phlex-\/chem}} module can be done in the following steps\+:

\subsection*{Step 1. Create a new aerosol representation module}

The module should be placed in the {\ttfamily /src/aero\+\_\+reps} folder and extend the abstract {\ttfamily \mbox{\hyperlink{structpmc__aero__rep__data_1_1aero__rep__data__t}{pmc\+\_\+aero\+\_\+rep\+\_\+data\+::aero\+\_\+rep\+\_\+data\+\_\+t}}} type, overriding all deferred functions, and providing a constructor that returns a pointer to a newly allocated instance of the new type\+:


\begin{DoxyCode}
\textcolor{keyword}{module} pmc\_aero\_rep\_foo

  \textcolor{keywordtype}{use }...

  \textcolor{keywordtype}{implicit none}
  \textcolor{keywordtype}{private}

  \textcolor{keywordtype}{public} :: aero\_rep\_foo\_t

  \textcolor{keyword}{type}, \textcolor{keyword}{extends}(\mbox{\hyperlink{structpmc__aero__rep__data_1_1aero__rep__data__t}{aero\_rep\_data\_t}}) :: aero\_rep\_foo\_t
  \textcolor{keyword}{contains}
    ... (all \textcolor{keywordtype}{deferred} functions) ...
\textcolor{keyword}{  end type }:: aero\_rep\_foo\_t
  
  \textcolor{comment}{! Constructor}
  \textcolor{keyword}{interface} aero\_rep\_foo\_t
    \textcolor{keywordtype}{procedure} :: constructor
\textcolor{keyword}{  end interface }aero\_rep\_foo\_t

\textcolor{keyword}{  function }\mbox{\hyperlink{namespacepmc__aero__phase__data_ae2a9e6bfb1747e2ace93ab3fadd55530}{constructor}}() \textcolor{keyword}{result} (new\_obj)
    \textcolor{keywordtype}{type}(aero\_rep\_foo\_t), \textcolor{keywordtype}{pointer} :: new\_obj
    \textcolor{keyword}{allocate}(new\_obj)
\textcolor{keyword}{  end function }\mbox{\hyperlink{namespacepmc__aero__phase__data_ae2a9e6bfb1747e2ace93ab3fadd55530}{constructor}}

  ...

\textcolor{keyword}{end module }pmc\_aero\_rep\_foo
\end{DoxyCode}


\subsection*{Step 2. Create a new aerosol representation state module}

The module should also be placed in the {\ttfamily /src/aero\+\_\+reps} folder and should extend the abstract {\ttfamily pmc\+\_\+aero\+\_\+rep\+\_\+state\+::aero\+\_\+rep\+\_\+state\+\_\+t} type, overriding all deferred functions, and providing a constructor that returns a pointer to a newly allocated instance of the new type\+:


\begin{DoxyCode}
\textcolor{keyword}{module} pmc\_aero\_rep\_foo\_state

  \textcolor{keywordtype}{use }...

  \textcolor{keywordtype}{implicit none}
  \textcolor{keywordtype}{private}

  \textcolor{keywordtype}{public} :: aero\_rep\_foo\_state\_t

  \textcolor{keyword}{type}, \textcolor{keyword}{extends}(aero\_rep\_state\_t) :: aero\_rep\_foo\_state\_t
  \textcolor{keyword}{contains}
    ... (all \textcolor{keywordtype}{deferred} functions) ...
\textcolor{keyword}{  end type }:: aero\_rep\_foo\_state\_t
  
  \textcolor{comment}{! Constructor}
  \textcolor{keyword}{interface} aero\_rep\_foo\_state\_t
    \textcolor{keywordtype}{procedure} :: constructor
\textcolor{keyword}{  end interface }aero\_rep\_foo\_state\_t

\textcolor{keyword}{  function }\mbox{\hyperlink{namespacepmc__aero__phase__data_ae2a9e6bfb1747e2ace93ab3fadd55530}{constructor}}() \textcolor{keyword}{result} (new\_obj)
    \textcolor{keywordtype}{type}(aero\_rep\_foo\_state\_t), \textcolor{keywordtype}{pointer} :: new\_obj
    \textcolor{keyword}{allocate}(new\_obj)
\textcolor{keyword}{  end function }\mbox{\hyperlink{namespacepmc__aero__phase__data_ae2a9e6bfb1747e2ace93ab3fadd55530}{constructor}}

  ...

\textcolor{keyword}{end module }pmc\_aero\_rep\_foo\_state
\end{DoxyCode}


\subsection*{Step 3. Add the aerosol representation to the {\ttfamily \mbox{\hyperlink{namespacepmc__aero__rep__factory}{pmc\+\_\+aero\+\_\+rep\+\_\+factory}}} module}


\begin{DoxyCode}
\textcolor{keyword}{module} \mbox{\hyperlink{namespacepmc__aero__rep__factory}{pmc\_aero\_rep\_factory}}

...

 \textcolor{comment}{! Use all aerosol representation modules}
 ...
 \textcolor{keywordtype}{use }pmc\_aero\_rep\_foo

 ...
\textcolor{comment}{}
\textcolor{comment}{ !> Identifiers for aerosol representations - used by binary packing/unpacking }
\textcolor{comment}{ !! functions}
 ...
 \textcolor{keywordtype}{integer(kind=i\_kind)}, \textcolor{keywordtype}{parameter} :: AERO\_REP\_FOO = 32

 ...
\textcolor{comment}{}
\textcolor{comment}{ !> Create a new aerosol representation by type name}
\textcolor{keyword}{ function }\mbox{\hyperlink{namespacepmc__aero__rep__factory_a72db65ee6fcec381e8315f2de1601953}{create}}(this, type\_name) \textcolor{keyword}{result} (new\_obj)
   ...
   \textcolor{keywordflow}{select case} (type\_name)
     ...
     \textcolor{keywordflow}{case} (\textcolor{stringliteral}{"AERO\_REP\_FOO"})
       new\_obj => aero\_rep\_foo\_t()
   ...
\textcolor{keyword}{ end function }\mbox{\hyperlink{namespacepmc__aero__rep__factory_a72db65ee6fcec381e8315f2de1601953}{create}}

...
\textcolor{comment}{}
\textcolor{comment}{ !> Pack the given value to the buffer, advancing position}
\textcolor{keyword}{ subroutine }\mbox{\hyperlink{namespacepmc__aero__phase__data_a3ee028d1595f33610a4359ddeb5fe249}{bin\_pack}}(this, aero\_rep, buffer, pos)
   ...
   \textcolor{keywordflow}{select type} (aero\_rep)
     ...
\textcolor{keywordflow}{     type is} (aero\_rep\_foo\_t)
       aero\_rep\_type = aero\_rep\_foo
   ...
\textcolor{keyword}{ end subroutine }\mbox{\hyperlink{namespacepmc__aero__phase__data_a3ee028d1595f33610a4359ddeb5fe249}{bin\_pack}}

...
\textcolor{comment}{}
\textcolor{comment}{ !> Unpack the given value to the buffer, advancing position}
\textcolor{keyword}{ function }\mbox{\hyperlink{namespacepmc__aero__phase__data_ab248ad8c703acdfc5f771aaca4671218}{bin\_unpack}}(this, buffer, pos) \textcolor{keyword}{result} (aero\_rep)
   ...
   \textcolor{keywordflow}{select case} (aero\_rep\_type)
     ...
     \textcolor{keywordflow}{case} (aero\_rep\_foo)
       aero\_rep => aero\_rep\_foo\_t()
   ...
\textcolor{keyword}{ end function }\mbox{\hyperlink{namespacepmc__aero__phase__data_ab248ad8c703acdfc5f771aaca4671218}{bin\_unpack}}
 
...
\textcolor{keyword}{end module }pmc\_aero\_rep\_factory
\end{DoxyCode}


\subsection*{Step 4. Add the new module to the C\+Make\+List file in the root directory.}


\begin{DoxyCode}
...

# partmc library
...
set(AEROSOL\_REPS\_SRC
  ...
  src/aero\_reps/aero\_rep\_foo.F90
  src/aero\_reps/aero\_rep\_foo\_state.F90
)

...
\end{DoxyCode}


\subsection*{Step 5. Add unit tests for the new {\ttfamily aero\+\_\+rep\+\_\+foo\+\_\+t} and {\ttfamily aero\+\_\+rep\+\_\+foo\+\_\+state\+\_\+t} types}

Unit testing should be based on the actual functions of the new module, but in general 80\% code coverage is recommended. Some examples can be found in the {\ttfamily /src/test} folder

\subsection*{Usage}

The new \mbox{\hyperlink{phlex_aero_rep}{aerosol representation}} is now ready to use. To include it in a {\ttfamily \mbox{\hyperlink{structpmc__phlex__core_1_1phlex__core__t}{pmc\+\_\+phlex\+\_\+core\+::phlex\+\_\+core\+\_\+t}}} instance, add an \mbox{\hyperlink{input_format_aero_rep}{aerosol representation object}} to a new or existing \mbox{\hyperlink{input_format_phlex_config}{phlex-\/chem configuration file}} with a {\bfseries type} corresponding to the newly created type, along with any required parameters\+:


\begin{DoxyCode}
\{ "pmc-data" : [
  \{
    "type" : "AERO\_REP\_FOO",
    ...
  \},
  ...
]\}
\end{DoxyCode}
 